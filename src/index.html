<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>JS Drum Kit</title>
  <link rel="stylesheet" href="bongocat.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&display=swap" rel="stylesheet">
</head>

<body onload="window.scrollTo(0, 0);">
  <div id="bongocat">
    <div id="table">
    </div>
    <div id="instruments">
      <div id="bongo"></div>
      <div id="keyboard"></div>
      <div id="cymbal"></div>
      <div id="marimba"></div>
      <div id="tambourine"></div>
      <div id="cowbell"></div>
      <div id="TR808"></div>  <!-- Added TR808 Pic here -->
    </div>

    <div id="cat">
      <div id="head"></div>
      <div id="mouth"></div>
      <div id="paw-left"></div>
      <div id="paw-right"></div>
      <div id="nametagwrapper"><span id="nametag"></span></div>
    </div>
  </div>

  <audio data-key="AL" data-paw="paw-left" data-instrument="bongo" src="sounds/bongocat/bongo0.mp3"></audio>
  <audio data-key="SL" data-paw="paw-right" data-instrument="bongo" src="sounds/bongocat/bongo1.mp3"></audio>
  <audio data-key="DL" data-paw="paw-left" data-instrument="cowbell" src="sounds/bongocat/cowbell.mp3"></audio>
  <audio data-key="FL" data-paw="paw-left" data-instrument="cymbal" src="sounds/bongocat/cymbal.mp3"></audio>
  <audio data-key="GL" data-paw="paw-left" data-instrument="tambourine" src="sounds/bongocat/tambourine.mp3"></audio>
  <audio data-key="ML" data-paw="mouth" data-instrument="none" src="sounds/bongocat/meow.mp3"></audio>

    <!-- extended drums start here, add 4 new sound to emty Keys X, C, B and N--> 

    <audio data-key="XL" data-paw="paw-left" data-instrument="TR808" src="sounds/bongocat/BD.mp3"></audio>
    <audio data-key="CL" data-paw="paw-right" data-instrument="TR808" src="sounds/bongocat/SD.mp3"></audio>
    <audio data-key="BL" data-paw="paw-left" data-instrument="TR808" src="sounds/bongocat/CH.mp3"></audio>
    <audio data-key="NL" data-paw="paw-right" data-instrument="TR808" src="sounds/bongocat/OH.mp3"></audio>
  
    <!-- extended drums ends here--> 

  <audio data-key="1L" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/c4.mp3"></audio>
  <audio data-key="2L" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/c4s.mp3"></audio>
  <audio data-key="3L" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/d4.mp3"></audio>
  <audio data-key="4L" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/d4s.mp3"></audio>
  <audio data-key="5L" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/e4.mp3"></audio>
  <audio data-key="6L" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/f4.mp3"></audio>
  <audio data-key="7L" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/f4s.mp3"></audio>
  <audio data-key="8L" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/g4.mp3"></audio>
  <audio data-key="9L" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/g4s.mp3"></audio>
  <audio data-key="0L" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/a4.mp3"></audio>

  <audio data-key="QL" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/c4.mp3"></audio>
  <audio data-key="WL" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/c4s.mp3"></audio>
  <audio data-key="EL" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/d4.mp3"></audio>
  <audio data-key="RL" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/d4s.mp3"></audio>
  <audio data-key="TL" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/e4.mp3"></audio>
  <audio data-key="YL" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/f4.mp3"></audio>
  <audio data-key="ZL" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/f4.mp3"></audio>
  <audio data-key="UL" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/f4s.mp3"></audio>
  <audio data-key="IL" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/g4.mp3"></audio>
  <audio data-key="OL" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/g4s.mp3"></audio>
  <audio data-key="PL" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/a4.mp3"></audio>

  <audio data-key="A" data-paw="paw-left" data-instrument="bongo" src="sounds/bongocat/bongo0.mp3"></audio>
  <audio data-key="S" data-paw="paw-right" data-instrument="bongo" src="sounds/bongocat/bongo1.mp3"></audio>
  <audio data-key="D" data-paw="paw-left" data-instrument="cowbell" src="sounds/bongocat/cowbell.mp3"></audio>
  <audio data-key="F" data-paw="paw-left" data-instrument="cymbal" src="sounds/bongocat/cymbal.mp3"></audio>
  <audio data-key="G" data-paw="paw-left" data-instrument="tambourine" src="sounds/bongocat/tambourine.mp3"></audio>
  <audio data-key="M" data-paw="mouth" data-instrument="none" src="sounds/bongocat/meow.mp3"></audio>

  <!-- extended drums start here, add 4 new sound to emty Keys X, C, B and N--> 

  <audio data-key="X" data-paw="paw-left" data-instrument="TR808" src="sounds/bongocat/BD.mp3"></audio>
  <audio data-key="C" data-paw="paw-right" data-instrument="TR808" src="sounds/bongocat/SD.mp3"></audio>
  <audio data-key="B" data-paw="paw-left" data-instrument="TR808" src="sounds/bongocat/CH.mp3"></audio>
  <audio data-key="N" data-paw="paw-right" data-instrument="TR808" src="sounds/bongocat/OH.mp3"></audio>

  <!-- extended drums ends here--> 

  <audio data-key="^1" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/c5.mp3"></audio>
  <audio data-key="^1#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/c5s.mp3"></audio>
  <audio data-key="^2" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/d5.mp3"></audio>
  <audio data-key="^2#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/d5s.mp3"></audio>
  <audio data-key="^3" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/e5.mp3"></audio>
  <audio data-key="^4" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/f5.mp3"></audio>
  <audio data-key="^4#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/f5s.mp3"></audio>
  <audio data-key="^5" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/g5.mp3"></audio>
  <audio data-key="^5#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/g5s.mp3"></audio>
  <audio data-key="^6" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/a5.mp3"></audio>
  <audio data-key="^6#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/a5s.mp3"></audio>
  <audio data-key="^7" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/b5.mp3"></audio>

  <audio data-key="1" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/c4.mp3"></audio>
  <audio data-key="1#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/c4s.mp3"></audio>
  <audio data-key="2" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/d4.mp3"></audio>
  <audio data-key="2#" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/d4s.mp3"></audio>
  <audio data-key="3" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/e4.mp3"></audio>
  <audio data-key="4" data-paw="paw-left" data-instrument="keyboard" src="sounds/bongocat/keyboard/f4.mp3"></audio>
  <audio data-key="4#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/f4s.mp3"></audio>
  <audio data-key="5" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/g4.mp3"></audio>
  <audio data-key="5#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/g4s.mp3"></audio>
  <audio data-key="6" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/a4.mp3"></audio>
  <audio data-key="6#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/a4s.mp3"></audio>
  <audio data-key="7" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/b4.mp3"></audio>

  <audio data-key="V1" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/c3.mp3"></audio>
  <audio data-key="V1#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/c3s.mp3"></audio>
  <audio data-key="V2" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/d3.mp3"></audio>
  <audio data-key="V2#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/d3s.mp3"></audio>
  <audio data-key="V3" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/e3.mp3"></audio>
  <audio data-key="V4" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/f3.mp3"></audio>
  <audio data-key="V4#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/f3s.mp3"></audio>
  <audio data-key="V5" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/g3.mp3"></audio>
  <audio data-key="V5#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/g3s.mp3"></audio>
  <audio data-key="V6" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/a3.mp3"></audio>
  <audio data-key="V6#" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/a3s.mp3"></audio>
  <audio data-key="V7" data-paw="paw-right" data-instrument="keyboard" src="sounds/bongocat/keyboard/b3.mp3"></audio>

  <audio data-key="^Q" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/c5.mp3"></audio>
  <audio data-key="^Q#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/c5s.mp3"></audio>
  <audio data-key="^W" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/d5.mp3"></audio>
  <audio data-key="^W#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/d5s.mp3"></audio>
  <audio data-key="^E" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/e5.mp3"></audio>
  <audio data-key="^R" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/f5.mp3"></audio>
  <audio data-key="^R#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/f5s.mp3"></audio>
  <audio data-key="^T" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/g5.mp3"></audio>
  <audio data-key="^T#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/g5s.mp3"></audio>
  <audio data-key="^Y" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/a5.mp3"></audio>
  <audio data-key="^Y#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/a5s.mp3"></audio>
  <audio data-key="^U" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/b5.mp3"></audio>

  <audio data-key="Q" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/c4.mp3"></audio>
  <audio data-key="Q#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/c4s.mp3"></audio>
  <audio data-key="W" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/d4.mp3"></audio>
  <audio data-key="W#" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/d4s.mp3"></audio>
  <audio data-key="E" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/e4.mp3"></audio>
  <audio data-key="R" data-paw="paw-left" data-instrument="marimba" src="sounds/bongocat/marimba/f4.mp3"></audio>
  <audio data-key="R#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/f4s.mp3"></audio>
  <audio data-key="T" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/g4.mp3"></audio>
  <audio data-key="T#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/g4s.mp3"></audio>
  <audio data-key="Y" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/a4.mp3"></audio>
  <audio data-key="Y#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/a4s.mp3"></audio>
  <audio data-key="U" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/b4.mp3"></audio>

  <audio data-key="VQ" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/c3.mp3"></audio>
  <audio data-key="VQ#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/c3s.mp3"></audio>
  <audio data-key="VW" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/d3.mp3"></audio>
  <audio data-key="VW#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/d3s.mp3"></audio>
  <audio data-key="VE" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/e3.mp3"></audio>
  <audio data-key="VR" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/f3.mp3"></audio>
  <audio data-key="VR#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/f3s.mp3"></audio>
  <audio data-key="VT" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/g3.mp3"></audio>
  <audio data-key="VT#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/g3s.mp3"></audio>
  <audio data-key="VY" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/a3.mp3"></audio>
  <audio data-key="VY#" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/a3s.mp3"></audio>
  <audio data-key="VU" data-paw="paw-right" data-instrument="marimba" src="sounds/bongocat/marimba/b3.mp3"></audio>

  <script src="dist/tmi.min.js"></script>

  <script type="module">

    (function () {
      var bpm = {};
      bpm.user = {};
      var queue = [];
      var bongoEnabled = true;
      var playing = false;
      setBPM(128);

      function setBPM(targetBPM, username) {
        if (targetBPM > 800 || targetBPM < 50) {
          return;
        }
        if (username === undefined) {
          console.log("<Global> current BPM: " + bpm.global + ". Target: " + Math.floor(60000 / targetBPM));
          bpm.global = Math.floor(60000 / targetBPM);
        } else {
          console.log("<User> current BPM for "+username+": " + bpm.user[username] + ". Target: " + Math.floor(60000 / targetBPM));
          bpm.user[username] = Math.floor(60000 / targetBPM);
        }
      }
      function playSound(cmd) {

        const audio = document.querySelector(`audio[data-key="${cmd}"]`);
        setInstrument(audio.dataset.instrument);
        setPaw(audio.dataset.paw);
        if (!audio) return;


        audio.currentTime = 0;
        audio.play();
      }
      function addToQueue(noteString, username, isLegacyNotation) {
        var newNoteStack = [];
        newNoteStack[0] = noteString;
        newNoteStack[1] = username;
        newNoteStack[2] = isLegacyNotation;
        queue.push(newNoteStack);
      }

      function getFromQueue() {
        var returnvalue = queue.pop();
        return returnvalue;
      }
      function startQueue() {
        setInterval(checkQueue, 1000);
      }
      function checkQueue() {
        if (queue.length > 0 && playing == false) {
          var song = getFromQueue();
          var noteString = song[0]
          var username = song[1];
          var isLegacyNotation = song[2];

          introAnimation(username);
          addNotes(noteString, isLegacyNotation, username);
        }

      }
      function parseNotes(noteBatch) {
        const fsmError = 0;
        const fsmStart = 1;
        const fsmPitch = 2;
        const fsmNote = 3;
        const fsmSharp = 4;

        var resultNotes = [];
        var thisNote;
        var state = fsmStart;

        for (var i = 0; i < noteBatch.length; i++) {
          var curChar = noteBatch[i];

          switch (state) {
            case fsmError: {
              console.log("fsmError");

              break;
            }

            case fsmStart: {
              console.log("fsmStart");

              thisNote = curChar;

              if (curChar == "^" || curChar == "V")
                state = fsmPitch;
              else
                state = fsmNote;
              break;
            }

            case fsmPitch: {
              console.log("fsmPitch");

              if (curChar == "^" || curChar == "V" || curChar == "#")
                state = fsmError;
              else {
                thisNote += curChar;
                state = fsmNote;
              }

              break;
            }

            case fsmNote: {
              console.log("fsmNote");

              if (curChar == "#") {
                thisNote += curChar;
                state = fsmSharp;
              }
              else {
                resultNotes.push(thisNote);
                state = fsmStart;
                i--;
              }

              break;
            }

            case fsmSharp: {
              console.log("fsmSharp");

              if (curChar == "#")
                state = fsmError;
              else {
                resultNotes.push(thisNote);
                state = fsmStart;
                i--;
              }

              break;
            }
          }
        }

        // epsilon:
        switch (state) {
          case fsmNote:
          case fsmSharp: {
            console.log("epsilon");
            resultNotes.push(thisNote);
            break;
          }
        }

        return resultNotes;
      }
      function getBpm(username) {
        if (username === undefined || bpm.user[username] === undefined) {
          return bpm.global;
        } else {
          return bpm.user[username];
        }
      }

      function addNotes(noteString, isLegacyNotation, username) {
        var noteBatches = noteString.split(" ");
        var thisNote;
        var thisTimer = 1000;
        var uBPM;
        uBPM = getBpm(username);

        for (var noteBatch in noteBatches) {
          var notes = parseNotes(noteBatches[noteBatch].substr(0, 5));
          if (notes.length > 0 && notes[0] == ",") {
            let sBpm = "";
            for (var i = 1; i <= notes.length; i++) {
              if (isNaN(notes[i])) {
                break;
              }
              sBpm += notes[i];
            }
            sBpm = sBpm.substring(0, 3);
            setBPM(Number(sBpm), username);
            uBPM = getBpm(username);
            continue
          }

          console.log(`result notes: ${notes}`);

          thisTimer += uBPM;
          for (var noteIdx in notes) {
            thisNote = notes[noteIdx];

            if (isLegacyNotation)
              thisNote += "L";

            setTimeout(playSound, thisTimer, thisNote);
          }
        }
        thisTimer += uBPM;
        setTimeout(outroAnimation, thisTimer);
      }
      function introAnimation(username) {
        document.getElementById("nametag").innerHTML = username + " entered the stage";
        document.getElementById("bongocat").style.left = "0px";
        playing = true;
      }
      function outroAnimation() {
        document.getElementById("bongocat").style.left = "-1920px";
        setInstrument("none");
        setTimeout(function () {
          playing = false;
        }, 1000);
      }
      function setInstrument(instrument) {
        var c = document.getElementById("instruments").children;
        for (var i = 0; i < c.length; i++) {
          c[i].style.visibility = "hidden";
        }
        var newInstrument = document.getElementById(instrument);
        if (!newInstrument) { return; }
        newInstrument.style.visibility = "visible";

      }
      function setPaw(paw) {
        var currentPaw = document.getElementById(paw);
        currentPaw.style.backgroundPosition = "top right";
        window.setTimeout(releasePaw, bpm / 2, paw);
      }
      function releasePaw(paw) {

        var currentPaw = document.getElementById(paw);
        currentPaw.style.backgroundPosition = "top left";
      }


      // tmijs
      const channel = location.hash || 'jvpeek';
      const chatClient = new tmi.Client({
        channels: [channel]
      });
      chatClient.connect();

      chatClient.on('connected', (address, port) => {
        console.log(`Connected to ${address}:${port}, channel ${channel}.`);
      });
      function isSuperUser(tags) {
        return tags.mod || tags.badges?.broadcaster || tags.username == "jvpeek"
      }
      chatClient.on('message', (channel, tags, message, self) => {

        if (message.startsWith("!")) {
          if (message.startsWith("!enablebongo") && isSuperUser(tags)) {
            console.log("aktiviere Bongo");
            bongoEnabled = true;
          }
          if (bongoEnabled == false) {
            return;
          }
          if (message.startsWith("!disablebongo") && isSuperUser(tags)) {
            console.log("deaktiviere Bongo");
            bongoEnabled = false;
          }
          if (message.startsWith("!bongo+ ")) {
            const notes = message.substr(8);
            console.log(`${tags.username} plays ${notes}.`);
            addToQueue(notes.toUpperCase(), tags.username, false);
          }
          if (message.startsWith("!bongo ")) {
            const notes = message.substr(7);
            console.log(`${tags.username} plays ${notes}.`);
            addToQueue(notes.toUpperCase(), tags.username, true);
          }
          if (message.startsWith("!bpm ")) {
            const targetBPM = Number(message.substr(5));
            if (targetBPM <= 600 && targetBPM > 49) {
              console.log(`${tags.username} set BPM to ${targetBPM}.`);
              setBPM(targetBPM, tags.username);
            }
          }

        }
      });

      startQueue();
    })();
  </script>
</body>

</html>